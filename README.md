````markdown
# Техническое задание  
на разработку системы функционального тестирования веб-сайтов  
с использованием нейросети для анализа HTML-структуры

---

## 1. Цель и общее описание системы

Цель: создать **масштабируемую систему функционального тестирования веб-сайтов**, которая:

1. Открывает реальные страницы (в т.ч. SPA, JS-heavy) через headless-браузер.
2. **Сканирует структуру сайта (HTML/DOM)** и сохраняет результаты.
3. Передаёт HTML-структуры в **нейросеть**, которая:
   - анализирует DOM/метаданные,
   - **предлагает “точки тестирования”** (критичные элементы, потоки, сценарии),
   - формирует рекомендации по асертам и шагам тестов.
4. Позволяет создавать, хранить и запускать **тесты и ассерты**:
   - вручную (на основе рекомендаций нейросети),
   - полуавтоматически (предзаполнение тестов из рекомендаций).
5. Имеет **панель администрирования** для управления:
   - проектами, окружениями, сканами,
   - тестами, наборами тестов (suites),
   - запуском и результатами.
6. Обеспечивает **запуск тестов по расписанию**:
   - через CLI/скрипты, подключаемые в Cron.
7. Имеет **отдельный проект “Карта тестов / Test Map / Карта мира”**:
   - каталог всех тестов и ассертов,
   - визуализация покрытия сайта,
   - связь тестов с конкретными зонами DOM и точками тестирования.
8. Предусматривает **подключение нейросети**:
   - локальной или внешней (через HTTP/gRPC),
   - с **опциональным использованием прокси-сервера** для доступа к нейросетевому API.

Система должна быть extensible: легко добавлять новые типы тестов, новые модели/провайдеры нейросети, новые источники данных.

---

## 2. Предпочтительный стек технологий

### 2.1. Архитектура

Рекомендуется микросервисный подход (можно стартовать с монолита + отдельных воркеров):

- **Сервис A: Test Runner & Scanner**
- **Сервис B: Test Map (Карта тестов)**
- **Сервис C: API & Admin Backend**
- **Сервис D: AI Assistant / Neural Analyzer** – интеграция с нейросетью
- **Frontend:** Admin Panel UI
- **CLI/скрипты** для Cron

### 2.2. Backend / API

- Язык: **Python 3.11+**
- Web-фреймворк: **FastAPI**
- Асинхронные задачи: **Celery + Redis** (или аналог очередей задач).
- Тест-раннер интегрируется с Playwright.

### 2.3. Headless-браузер и сканер

- **Playwright** (Python):
  - поддержка Chromium/Firefox/WebKit,
  - удобный API для сложных сценариев.

### 2.4. Нейросеть / AI

- Сервис D (**AI Assistant / Neural Analyzer**):
  - Язык: Python (FastAPI или отдельный воркер).
  - Взаимодействие с моделью:
    - либо локальная модель,
    - либо внешний AI-провайдер (HTTP/gRPC).
  - Формат взаимодействия: JSON.
  - Поддержка **настройки прокси** для HTTP-запросов к AI-провайдеру:
    - HTTP(S) proxy, опционально SOCKS5.
    - Настройки на уровне окружения / проекта.

### 2.5. База данных

- Основная БД: **PostgreSQL**
- Кэш/очереди: **Redis**

### 2.6. Admin Panel (Frontend)

- Язык: **TypeScript**
- Framework: **React** (или Vue 3 – по решению команды).
- UI-библиотека: MUI / Ant Design.

### 2.7. Инфраструктура

- **Docker** + `docker-compose`, далее возможен переход на Kubernetes.
- Веб-сервер: **nginx** (reverse-proxy).
- Логи: structured logs (JSON) в stdout + централизованный сбор (опционально).
- Мониторинг: Prometheus + Grafana (опционально).

### 2.8. Интеграция с Cron

- CLI-команды/скрипты:
  - запуск suite’ов,
  - возможность указания проекта/окружения.
- Cron-задания на стороне DevOps.

---

## 3. Основные сущности (модель предметной области)

1. **Project (Проект)**  
   Логическое объединение сайтов и тестов.

2. **Environment (Окружение)**  
   Примеры: `prod`, `staging`, `dev`.  
   Влияет на базовый URL, авторизацию, конфиги AI/прокси.

3. **Target (Сайт / Целевой ресурс)**  
   Домен/поддомен/базовый URL + правила обхода.

4. **Scan Job (Задача сканирования)**  
   Запуск Playwright для обхода сайта и сохранения DOM/метаданных.

5. **Page (Страница)**  
   Конкретный URL, DOM-снимок, статус код, метаданные.

6. **AI Analysis (Результат анализа нейросети)**  
   Для каждой страницы/набора страниц:
   - список “точек тестирования”:
     - важные селекторы,
     - элементы (формы, кнопки “Купить”, шаги воронки),
     - пользовательские потоки (например, “логин”, “чекаут”),
   - предложенные ассерты.

7. **Test Case (Тест)**  
   Структурированный сценарий:
   - шаги (actions),
   - ассерты (assertions),
   - связь с AI-предложениями (опционально).

8. **Test Suite (Набор тестов)**  
   Группа тестов для совместного запуска (smoke, регрессия и т.п.).

9. **Test Run (Запуск теста/набора)**  
   Конкретное выполнение с результатами и артефактами.

10. **Test Map (Карта тестов / Карта мира)**  
    Отдельный проект/сервис:
    - хранит структуру тестов по проектам/окружениям,
    - показывает покрытие сайта тестами,
    - содержит связи “страница → точки тестирования → тесты”.

11. **AI Provider Config (Настройки нейросети)**  
    - тип провайдера (локальная модель, внешний API и т.д.),
    - endpoint,
    - ключи/токены,
    - **параметры прокси (опционально)**.

---

## 4. Архитектура и модули

### 4.1. Сервис A: Scanner & Runner

**Ответственность:**

- Сканирование сайтов (Scan Jobs):
  - запуск Playwright,
  - загрузка страниц, обход ссылок,
  - сохранение DOM/метаданных в БД/хранилище.
- Запуск тестов:
  - получение тестов из Test Map,
  - выполнение шагов,
  - применение ассертов,
  - сохранение результатов Test Run.

**Дополнительно:**

- Взаимодействие с AI-сервисом:
  - по запросу: передать HTML/DOM для анализа,
  - получить JSON с “точками тестирования” и предложенными асертами,
  - сохранить связь “страница ↔ AI-рекомендации”.

### 4.2. Сервис D: AI Assistant / Neural Analyzer

**Функционал:**

1. Принимает запрос от Scanner/Backend:
   - входные данные:
     - HTML/DOM страницы (строка),
     - мета-информация (URL, title, статус, технические данные),
     - опционально: язык сайта, тип страницы (если известен).
2. Вызывает нейросеть (локально или внешне):
   - формирует промпт/структуру запроса,
   - учитывает **настройки прокси**, если указаны:
     - берёт из конфигов окружения/проекта,
     - применяет к HTTP-клиенту.
3. Возвращает структурированный ответ:

```json
{
  "version": "1.0",
  "page_url": "https://example.com/checkout",
  "test_points": [
    {
      "id": "checkout-submit",
      "type": "button",
      "selector": "button[type=submit].checkout-button",
      "description": "Кнопка оформления заказа",
      "recommended_assertions": [
        { "type": "element_exists" },
        { "type": "enabled" },
        { "type": "text_contains", "value": "Оплатить" }
      ]
    },
    {
      "id": "login-form",
      "type": "form",
      "selector": "form#login",
      "description": "Форма логина",
      "flow_hint": "start_auth_flow"
    }
  ],
  "flows": [
    {
      "id": "auth_flow",
      "description": "Авторизация пользователя",
      "steps_suggestion": [
        "goto /login",
        "fill email",
        "fill password",
        "click submit",
        "wait dashboard"
      ]
    }
  ]
}
````

4. Логирование и трейс:

   * логировать запрос/ответ (без лишних персональных данных),
   * в случае ошибки – статус и детализацию.

### 4.3. Сервис B: Test Map (Карта тестов)

**Отдельный проект** (отдельный репозиторий):

* Хранит:

  * метаданные тестов, версионность,
  * связи с проектами/окружениями,
  * связи с AI-точками тестирования.
* Предоставляет API:

  * `GET /test-map/tests?project=...`
  * `GET /test-map/test/{id}`
  * `POST /test-map/test` – создание/обновление,
  * `GET /test-map/coverage?page_id=...` – какие тесты покрывают эту страницу.
* Должен уметь отображать:

  * древовидную структуру тестов,
  * карту “страница → тесты → ассерты”,
  * маркировку: критичность, стабильность, автор.

### 4.4. Сервис C: API & Admin Backend

**Функционал:**

* Аутентификация/авторизация (JWT/session).
* CRUD:

  * проекты, окружения, таргеты,
  * связи с Test Map,
  * конфиги AI-провайдеров и **прокси**.
* Запуск:

  * инициировать сканы,
  * запускать test suites.
* Аггрегация:

  * получение результатов от Runner,
  * предоставление данных фронтенду (панель).

---

## 5. Интеграция с нейросетью и прокси

### 5.1. Общие требования

1. Интеграция с нейросетью должна быть **плагиноподобной**:

   * реализация интерфейса “AI-провайдера”,
   * возможность подключать разные провайдеры (локальные, внешние).
2. Все параметры подключения (URL, ключи, прокси) **не зашиваются в код**, а читаются из:

   * конфиг-файлов,
   * переменных окружения,
   * настроек в БД (per-environment).

### 5.2. Настройки провайдера нейросети

Для каждого окружения/проекта в БД хранить:

* `ai_provider_type` (строка, напр. `local_llm`, `external_openai`, `custom_api`).
* `ai_endpoint` (URL API).
* `ai_api_key` / токен (секретно).
* `ai_model` (имя модели – опционально).
* **Proxy-параметры (опциональные)**

  * `ai_proxy_enabled` (bool),
  * `ai_proxy_url` (напр. `http://user:pass@host:port`),
  * `ai_proxy_type` (http/https/socks5),
  * при отключённом флаге – запросы к нейросети идут напрямую.

### 5.3. Поведение при использовании прокси

* При `ai_proxy_enabled = true`:

  * все исходящие HTTP-запросы к `ai_endpoint` должны идти через указанный прокси.
* При `false`:

  * стандартное сетевое поведение.
* При ошибках прокси:

  * логировать ошибку отдельным типом (proxy_error),
  * возвращать в Backend понятное описание (для отображения в админке),
  * не “падать” всей системой (ошибка конкретного анализа).

### 5.4. Вызовы AI

**Сценарий:**

1. Сканер завершает обработку страницы и сохраняет DOM.
2. По конфигурации проекта:

   * либо сразу создаётся задача `ai_analyze_page`,
   * либо администратор вручную инициирует анализ.
3. Задача `ai_analyze_page`:

   * забирает HTML/DOM,
   * формирует запрос к `AI Assistant`,
   * AI Assistant использует указанный провайдер + прокси (если включен),
   * сохраняет результат в таблицу `ai_analysis`.
4. Далее:

   * админ/QA в панели видит для страницы:

     * список предложенных точек тестирования,
     * предложенные сценарии,
     * кнопки “создать тест из рекомендации”.

---

## 6. Панель администрирования (Frontend)

### 6.1. Основные разделы

1. **Dashboard**

   * Сводка по тестам, ошибкам, последним сканам.
2. **Проекты / Окружения**

   * настройка базовых URL, авторизации, таймаутов,
   * настройка AI-провайдера и прокси:

     * выбор провайдера,
     * ввод endpoint,
     * токен,
     * включение/выключение прокси + URL прокси.
3. **Сайты и сканирование**

   * управление target’ами,
   * запуск сканов,
   * просмотр карты сайта.
4. **AI-рекомендации**

   * список страниц с наличием/отсутствием анализа,
   * статус AI-анализов (успех/ошибка/proxy-ошибка),
   * просмотр “точек тестирования” по странице и создание на их основе тестов.
5. **Карта тестов (Test Map)**

   * интеграция с сервисом Test Map:

     * просмотр дерева тестов,
     * покрытие страниц тестами,
     * состояние тестов (стабильность, критичность).
6. **Suites & Runs**

   * управление наборами тестов,
   * запуск, история, детальные результаты.
7. **Расписания / Cron**

   * генерация команд для crontab,
   * просмотр “запланированных” запусков и фактических.

---

## 7. Функциональные требования

### 7.1. Сканирование сайта

* Поддержка:

  * многостраничных сайтов,
  * SPA (ожидание по `networkidle` или по селектору),
  * кастомные заголовки/авторизация.
* Сохранение:

  * HTML/DOM (в файлах или в БД/объектном хранилище),
  * метаданные (URL, статус, title, meta, canonical, H1 и др.).

### 7.2. Анализ HTML нейросетью

* Для каждой страницы:

  * отправка HTML в AI-сервис,
  * учёт конфигурации прокси,
  * получение JSON с:

    * точками тестирования (selectors, descriptions, priority),
    * рекомендациями по асертам и сценариям.
* Возможность:

  * фильтровать по “AI-анализ проведён / не проведён / ошибка прокси / ошибка провайдера”,
  * повторно запускать анализ.

### 7.3. Создание тестов на основе AI

* В панели:

  * отображать список рекомендованных точек тестирования,
  * давать возможность “создать тест из рекомендации”:

    * предварительно заполненные шаги (goto, click, fill),
    * ассерты (element_exists, text_contains и т.п.),
    * параметры можно отредактировать вручную.
* Созданный тест сохраняется в Test Map.

### 7.4. Запуск тестов и отчётность

* Запуск:

  * вручную из панели (по одному тесту, suite).
  * программно (через API/CLI для Cron).
* Отчёты:

  * статус тестов,
  * логи шагов,
  * скриншоты, HTML-снапшоты,
  * связь с AI-точками (какая рекомендация привела к этому тесту).

---

## 8. Нефункциональные требования

1. **Масштабируемость**

   * горизонтальное масштабирование воркеров Runner и AI Assistant.
2. **Конфигурируемость**

   * все параметры AI/прокси – через конфиг/панель, без правки кода.
3. **Безопасность**

   * безопасное хранение токенов (в секрете/хранилище секретов).
   * ограничение доступа к AI-конфигам по ролям.
4. **Надёжность**

   * система должна корректно обрабатывать:

     * недоступность AI-провайдера,
     * ошибки прокси,
     * таймауты.
   * не блокировать основную работу (сканы и запуск тестов) при временных проблемах с AI.

---

## 9. Пример структуры БД (упрощённо)

### Основные таблицы

* `projects`
* `environments` (project_id, name, base_url, config_json)
* `targets` (project_id, environment_id, base_url, include_patterns, exclude_patterns)
* `scan_jobs` (target_id, status, started_at, finished_at, stats_json)
* `pages` (scan_job_id, url, status_code, title, dom_ref, meta_json)

### AI-анализ

* `ai_providers` (id, name, type, default_config)
* `environment_ai_settings`:

  * environment_id
  * provider_id
  * endpoint
  * api_key (секрет)
  * model
  * proxy_enabled (bool)
  * proxy_url
  * proxy_type
* `ai_analysis`:

  * page_id
  * provider_id
  * status (`success`, `error`, `proxy_error`, `timeout`)
  * request_timestamp
  * response_json (структура с тестовыми точками)
  * error_message

### Тесты и запуски

* `suites`
* `test_runs`
* `test_run_items`
* (структура тестов и версий – в сервисе Test Map)

---

## 10. Интеграция с Cron (пример)

Пример команд:

```bash
# запуск smoke-набора для проекта X на prod
python -m tests_runner run-suite \
  --suite-id=123 \
  --environment=prod \
  --trigger=cron
```

Crontab:

```cron
0 3 * * * /usr/bin/docker exec test_runner \
  python -m tests_runner run-suite \
  --suite-id=123 --environment=prod --trigger=cron \
  >> /var/log/test_runner.log 2>&1
```

Панель должна показывать готовую строку для crontab.

---

## 11. Критерии готовности MVP

1. Создание проекта и окружения с настройками AI и прокси в панели.
2. Настройка target-сайта, запуск сканирования, получение карты страниц.
3. Вызов нейросети для анализа DOM хотя бы для одной страницы:

   * через AI-сервис с учётом прокси,
   * успешное получение “точек тестирования”.
4. Возможность:

   * на основе AI-рекомендации создать тест в Test Map,
   * включить тест в suite.
5. Запуск suite:

   * вручную из панели,
   * через CLI/cron.
6. Просмотр отчётов по запуску с:

   * статусами тестов,
   * логами шагов,
   * базовыми артефактами (скриншоты при падении).
7. В случае недоступности AI/прокси:

   * тестирование сайта и сохранение DOM продолжается,
   * в панели видно, что AI-анализ не выполнен / ошибка.

---

```
```

## Реализация MVP

В репозитории добавлен минимальный работающий скелет системы на FastAPI, SQLModel и Typer, покрывающий требования ТЗ:

- **API (FastAPI)**: управление проектами, окружениями, целями, запусками сканов, анализом HTML и созданием тестовых сущностей.
- **Сканер (Playwright-ready)**: асинхронный сбор DOM через `httpx` с последующим сохранением страниц и базовой статистики; легко заменить на Playwright при необходимости.
- **AI-анализ**: локальный `DOMAIAnalyzer` оценивает DOM, выделяет точки тестирования (формы, кнопки, ссылки) и сохраняет рекомендации.
- **Тест-раннер**: формирует запуски suite’ов, исполняет smoke-check тесты и фиксирует результаты.
- **CLI**: команды для инициализации БД, запуска сканов, выполнения suite’ов и вывода примера Cron-задания.

### Быстрый старт

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Инициализируйте БД SQLite:
   ```bash
   python -m app.cli init
   ```
3. Запустите API (например, на 8000 порту):
   ```bash
   uvicorn app.main:app --reload
   ```
4. Создайте проект/окружение/target через API, затем выполните скан:
   ```bash
   http POST :8000/projects name="Demo"
   http POST :8000/environments name="prod" base_url="https://example.com" project_id==1
   http POST :8000/targets name="Example" base_url="https://example.com" project_id==1 environment_id==1
   http POST :8000/scan/1
   ```
5. Запросите AI-анализ любой сохранённой страницы:
   ```bash
   http POST :8000/ai/analyze/1
   ```
6. Запустите suite из Cron/CLI:
   ```bash
   python -m app.cli run-suite-cmd --suite-id=1 --environment-id=1 --trigger=cron
   ```

### Основные файлы

- `app/main.py` — FastAPI-приложение и маршруты.
- `app/models.py` — модели домена (проекты, окружения, таргеты, сканы, страницы, AI-конфиг, тестовые сущности).
- `app/scanner.py` — сбор DOM и страниц.
- `app/ai.py` — эвристический анализ HTML и генерация точек тестирования.
- `app/test_runner.py` — выполнение suite’ов и простые smoke-check тесты.
- `app/cli.py` — Typer-команды для Cron/скриптов.

MVP использует SQLite и локальный анализ DOM; при необходимости подключите Playwright и внешнего AI-провайдера, добавив реальный HTTP/gRPC-клиент в `app/ai.py` и расширив `app/scanner.py`.
